# 前端 i18n 設計草案

後端已提供錯誤回應的 `i18n_key` 與參數，前端需同步規劃國際化架構。本文件記錄初始方案，確保 UI 錯誤提示與流程訊息可逐步本地化。

## 現況

- 專案尚未導入任何 i18n 套件。
- `next.config.ts` 沒有設定 `i18n` 區段。
- 後端錯誤回應格式含 `i18n_key`、`i18n_params`，若前端不支援將無法顯示本地化訊息。
- 產品需要支援 **繁體中文（預設）** 與 **英文**，並允許使用者手動切換。

## 目標

1. 允許頁面與元件以型別安全的方式讀取翻譯。
2. 能處理 Server Component 與 Client Component 的混用（符合 Next.js App Router 特性）。
3. 讓錯誤訊息映射後端 `i18n_key` → 翻譯字串。
4. 維持語言切換、fallback、格式化（日期/數字）等彈性。

## 推薦工具：`next-intl`

理由：

- 官方推薦，支援 App Router、Server Component。
- 提供型別推導，避免 key 拼錯。
- Server/Client 層都可使用 `useTranslations` / `getTranslations` / `useFormatter`。

### 安裝步驟

```bash
cd frontend
pnpm add next-intl
```

### 設定示意

1. 在 `next.config.ts` 新增 i18n 參數：
   ```ts
   const nextConfig: NextConfig = {
     i18n: {
       locales: ["zh-TW", "en"],
       defaultLocale: "zh-TW",
     },
   };
   ```
2. 採用 Next.js App Router 推薦的 `[locale]` 路由前綴：
   - 建立 `app/[locale]/layout.tsx`，在 server 端透過 `NextIntlServerProvider` 注入 `messages`。
   - 將原本 `app/page.tsx` 移至 `app/[locale]/page.tsx`，預設由 `middleware.ts` 將未指定語系的請求導向 `/zh-TW`。
3. 建立 `src/i18n/request.ts` 管理 `getTranslator` 與 `getMessages`：

   ```ts
   import { getRequestConfig } from "next-intl/server";

   export default getRequestConfig(async ({ locale }) => ({
     locale,
     messages: (await import(`../messages/${locale}.json`)).default,
   }));
   ```

4. 在 `app/providers.tsx` 中使用 `NextIntlClientProvider`，讓 Client Component 取得 `useTranslations()`。

> 語言偵測：優先讀取 URL 前綴，其次讀取 `NEXT_LOCALE` cookie，再 fallback 至 `zh-TW`。可在 `middleware.ts` 內實作。

### 翻譯檔案結構（決議）

```
frontend/
  messages/
    zh-TW/
      common.json
      errors.json
      mcp.json
    en/
      common.json
      errors.json
      mcp.json
  app/
    (public)/
      layout.tsx
    (dashboard)/
      layout.tsx
```

- `common.json`: 共用字串（按鈕、標題、共用提示）。
- `errors.json`: 對應後端 `i18n_key`，必須維持鍵名一致，如 `errors.mcp.connection_failed`。
- `mcp.json`: MCP 功能相關 UI 文案。

## 錯誤訊息映射策略

1. `apiClient` 捕捉到後端回傳的錯誤，讀取 `i18n_key` 與 `i18n_params`。
2. 使用 `next-intl` 的 `formatMessage` 或 `translate`，依 key 拿到對應文字並帶入參數。
3. 若 key 缺失，則 fallback 至 `error.message` 或預設錯誤提示。

### 命名規則

- 後端 `i18n_key` 採用 `errors.<domain>.<name>` 格式，例如 `errors.mcp.connection_failed`、`errors.auth.token_expired`。
- UI 一般字串放在 `common.*` 或功能命名空間，例如 `mcp.serverStatus.connected`。
- 建議在 PR 中同步補上中英雙語，空字串以 TODO 註記，避免意外上線。

### `lib/api-error.ts` (草案)

```ts
export class ApiError extends Error {
  constructor(
    public readonly type: string,
    public readonly traceId: string | undefined,
    public readonly i18nKey?: string,
    public readonly i18nParams?: Record<string, string | number>,
    message?: string,
  ) {
    super(message);
  }
}
```

### `lib/api-client.ts` (草案)

```ts
import { ApiError } from "./api-error";

export async function request<T>(
  input: RequestInfo,
  init?: RequestInit,
): Promise<T> {
  const res = await fetch(input, init);
  const payload = await res.json();

  if (!payload.success) {
    throw new ApiError(
      payload.error?.type ?? "UnknownError",
      payload.error?.trace_id ?? payload.trace_id,
      payload.error?.i18n_key,
      payload.error?.i18n_params,
      payload.error?.message,
    );
  }

  return payload.data as T;
}
```

- 之後可在 React 端補上一層 hook 擷取 `i18nKey`，透過 `useTranslations("errors")` 做本地化。

## 使用者切換與格式化

- Header 內放置 `LocaleSwitcher`（Client Component），寫入 `NEXT_LOCALE` cookie 並重新導向對應語系路徑。
- 日期、貨幣、數字另切 `formatters.ts`，共用 `useFormatter()`：
  ```ts
  const formatter = useFormatter();
  formatter.number(total, { style: "currency", currency: "USD" });
  ```

## 未來 TODO

- 建立 `middleware.ts` 處理預設導向與 cookie 語系。
- 撰寫 `LocaleSwitcher` 元件與相關測試。
- 與後端協調 `i18n_key`/`i18n_params` 清單，避免缺字串。
- 規劃自動化檢查（如 `next-intl/plugin`) 確保翻譯完整度。

> 後續落實後，記得同步更新本文件與 `next.config.ts`、翻譯檔案結構。
